<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Chicago Crime - flexio-sdk-js</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Javascript SDK for managing Flex.io resources and services">

    <meta name="twitter:title" content="flexiodata/flexio-sdk-js">
    <meta name="twitter:description" content="Javascript SDK for managing Flex.io resources and services">

    <meta property="og:title" content="flexiodata/flexio-sdk-js">
    <meta property="og:url" content="https://github.com/flexiodata/flexio-sdk-js/">
    <meta property="og:description" content="Javascript SDK for managing Flex.io resources and services">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600,700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.6.1/tachyons.min.css" integrity="sha256-eu1dpzpUytdOAUmB67Qi3mBb6HFjruP8BoAzk4lKiSc=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" integrity="sha256-3YM6A3pH4QFCl9WbSU8oXF5N6W/2ylvW0o2g+Z6TmLQ=" crossorigin="anonymous" />
  </head>
  <body>
    <div id="app">
      <div class="pa4">
        <pre style="font-size: 13px"><code></code></pre>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="../../dist/flexio.min.js"></script>
    <script>
      Flexio.setup('gnffbxwtrrqfkvxdmrjs')
      Flexio.setBaseUrl('https://test.flex.io/api/v1')

      Flexio.pipe()
        .input('https://raw.githubusercontent.com/flexiodata/examples/master/chicago-crime/chicago-homicides-2001-2016.csv')
        .convert('csv', 'table')
        .select('date', 'year', 'block', 'description', 'location description', 'latitude', 'longitude')
        .filter("year = '2016'")
        .convert('table', 'json')
        /*
        .execute('javascript', function() {
          var _ = require('lodash')

          exports.flexio_file_handler = function(input, output) {
            var arr = input.read()
            arr = JSON.parse(arr)
            output.write(JSON.stringify(arr))
          }
        })
        */
        .javascript(function(input, output) {
          // Lodash on the Flex.io server :-)
          var _ = require('lodash')

          // read the input (which was output from the previous task)
          var str = input.read()

          // convert the string into an array of JSON objects
          var arr = JSON.parse(str)

          // massage the output for our purposes
          arr = _.map(arr, function(a) {
            //
            var retval = _.pick(a, ['date', 'block', 'description'])

            // trim down our response; clean up our strings and key values and
            // add position coordinates as an object for Google Maps to use
            return {
              date: a.date,
              title: _.startCase(_.lowerCase(a.block)),
              desc: _.capitalize(a.description),
              loc_desc: _.startCase(_.lowerCase(_.get(a, 'location description', ''))),
              position: {
                lat: parseFloat(a.latitude),
                lng: parseFloat(a.longitude)
              }
            }
          })
          output.write(JSON.stringify(arr))
        })
        .run(function(err, result) {
          $('#app').find('pre code').text(JSON.stringify(result, null, 2))
        })
    </script>
  </body>
</html>
