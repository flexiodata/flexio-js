<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Chicago Crime By Year</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Looking up chicago crime data by year using the Flex.io Javascript SDK">

    <meta name="twitter:title" content="Chicago Crime By Year">
    <meta name="twitter:description" content="Looking up chicago crime data by year using the Flex.io Javascript SDK">

    <meta property="og:title" content="Chicago Crime By Year">
    <meta property="og:url" content="https://github.com/Chicago Crime By Year/">
    <meta property="og:description" content="Looking up chicago crime data by year using the Flex.io Javascript SDK">

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,600,700">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.6.1/tachyons.min.css" integrity="sha256-eu1dpzpUytdOAUmB67Qi3mBb6HFjruP8BoAzk4lKiSc=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" integrity="sha256-3YM6A3pH4QFCl9WbSU8oXF5N6W/2ylvW0o2g+Z6TmLQ=" crossorigin="anonymous" />

    <!-- site css goes here -->
    <style>
      html, body {
        font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: 0;
        height: 100%;
        color: #333;
      }

      /* Same as .flex-auto in Tachyons except without the 'auto' flex-basis */

      .flex-fill {
        flex: 1 1;
        min-width: 0; /* 1 */
        min-height: 0; /* 1 */
      }

      /* Button hover */

      .darken-10:hover,
      .darken-10:focus {
        box-shadow: inset 9999px 9999px rgba(0,0,0,0.10)
      }

      .darken-10:active {
        box-shadow: inset 9999px 9999px rgba(0,0,0,0.20)
      }
    </style>
  </head>
  <body>
    <!-- site content goes here -->
    <div class="flex flex-column fixed absolute--fill overflow-hidden">
      <div class="flex flex-row items-center pa3 bb b--black-20">
        <div class="flex-none f4 fw6 ma0">Chicago Homicides By Year</div>
        <form class="flex flex-row ml3">
          <select class="year-select ba b--black-20 pv1 ph2 f6" name="year"></select>
          <button type="button" class="btn-submit border-box no-select ba ttu b f6 ph3 pv2 br1 white bg-blue b--blue darken-10 ml2">Submit</button>
        </form>
      </div>
      <div id="map" class="flex-fill"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="../../dist/flexio.min.js"></script>
    <script>
      var g_map
      var g_markers = []

      var initMap = function()
      {
        var chicago = {
          lat:  41.8781,
          lng: -87.6378
        }

        g_map = new google.maps.Map(document.getElementById('map'), {
          zoom: 11,
          center: chicago
        })
      }

      // fill out select with years
      var cur_year = new Date().getFullYear()
      var opts = ''

      for (var y = 2001; y < cur_year; ++y)
      {
        opts += '<option value="'+y+'">'+y+'</option>'
      }

      $('.year-select').append(opts).val(cur_year-1)

      /* ---- BEGIN FLEX.IO EXAMPLE ---------------------------------------- */

      // initialize the Flex.io Javascript SDK with our API key
      Flexio.setup('gnffbxwtrrqfkvxdmrjs')

      // change the API base url for all Flex.io Javascript SDK calls
      Flexio.setBaseUrl('https://test.flex.io/api/v1')

      var doSubmit = function() {
        // clear all existing markers
        for (var i = 0; i < g_markers.length; ++i)
        {
          g_markers[i].setMap(null)
        }
        g_markers = []

        // grab the year from them select dropdown
        var year = $('.year-select').val()

        // run the following Flex.io pipe to get our result set
        Flexio.pipe()
          .input('https://raw.githubusercontent.com/flexiodata/examples/master/chicago-crime/chicago-homicides-2001-2016.csv')
          .convert('csv', 'table')
          .select('date', 'year', 'block', 'description', 'location description', 'latitude', 'longitude')
          .filter("year = '"+year+"'")
          .convert('table', 'json')
          .javascript(function(input, output) {
            // use Lodash on the Flex.io server :-)
            var _ = require('lodash')

            // read the input (which was output from the previous task)
            var str = input.read()

            // convert the string into an array of JSON objects
            var arr = JSON.parse(str)

            // massage the output for our purposes
            arr = _.map(arr, function(a) {
              // trim down our response
              var retval = _.pick(a, ['date', 'block', 'description'])

              // clean up our strings and key values and
              // add position coordinates as an object for Google Maps to use
              return _.assign(retval, {
                location_description: _.get(a, 'location description', ''),
                position: {
                  lat: parseFloat(a.latitude),
                  lng: parseFloat(a.longitude)
                }
              })
            })

            // output the result to the next task
            output.write(JSON.stringify(arr))
          })
          .run(function(err, result) {
            if (err)
            {
              alert("Something went wrong and we couldn't complete the request.")
            }
             else
            {
              for (var i = 0; i < result.length; ++i)
              {
                // create a new marker
                var marker = new google.maps.Marker({
                  position: result[i].position,
                  map: g_map
                })

                // add info window for when markers are clicked
                marker.info = new google.maps.InfoWindow({
                  content: "<p><b>"+result[i].description+"</b><br/>"+
                           result[i].date+"</p>" +
                           "<p>"+result[i].block+"<br/>"+
                           result[i].location_description+"</p>"
                })

                // show info window when markers are clicked
                marker.addListener('click', function() {
                  this.info.open(this.getMap(), this)
                })

                // add marker
                g_markers.push(marker)
              }
            }
          })
      }

      /* ---- END FLEX.IO EXAMPLE ------------------------------------------ */

      // do a new submit when a new year is selected in the dropdown
      $('form').on('submit', function(evt) {
        evt.preventDefault()
        doSubmit()
      })

      // do a new submit when the submit button is clicked
      $('.btn-submit').click(function(evt) {
        doSubmit()
      })

      // start off by doing an inital submit for the current year
      doSubmit()
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxfb6JACKlfD6IJLQlmvj3Gwo_ynvbXt4&callback=initMap"></script>
  </body>
</html>
